<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking App - AIæ™ºèƒ½ç‰ˆ</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="AIé©±åŠ¨çš„é›…æ€å£è¯­ç»ƒä¹ åº”ç”¨ï¼Œæä¾›å®æ—¶è¯­éŸ³è¯†åˆ«å’Œæ™ºèƒ½è¯„åˆ†">
    <meta name="theme-color" content="#4facfe">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="IELTS AI">
    
    <!-- PWA Icons (placeholder) -->
    <!-- <link rel="apple-touch-icon" href="icon-192.png"> -->
    <!-- <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png"> -->
    <!-- <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png"> -->
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- é¢˜åº“ç³»ç»Ÿ -->
    <script src="ielts-question-bank.js"></script>
    <!-- é«˜çº§åˆ†æå¼•æ“ -->
    <script src="advanced-analysis-engine.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border: none;
            background: none;
            font-size: 16px;
        }

        .tab:hover {
            background: rgba(79, 172, 254, 0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .recording-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .recording-controls {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .transcript-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
        }

        .category-selector {
            margin-bottom: 20px;
        }

        .category-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .category-selector select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .record-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(238, 90, 82, 0.3);
            margin: 20px 0;
        }

        .record-btn:hover {
            transform: translateY(-2px);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .timer {
            font-size: 2em;
            font-weight: 600;
            color: #333;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .transcript-display {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
        }

        .transcript-final {
            color: #333;
        }

        .transcript-interim {
            color: #888;
            font-style: italic;
        }

        .analysis-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .score-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .score-card:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.1);
        }

        .score-value {
            font-size: 2.5em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .score-value.excellent { color: #28a745; }
        .score-value.good { color: #17a2b8; }
        .score-value.average { color: #ffc107; }
        .score-value.poor { color: #dc3545; }

        .score-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .score-details {
            font-size: 0.9em;
            color: #666;
        }

        .feedback-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feedback-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .feedback-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feedback-list {
            list-style: none;
        }

        .feedback-list li {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .save-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }

        .save-section input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .speech-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            font-size: 14px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-indicator.active {
            background: #28a745;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        .waveform {
            height: 140px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid #e9ecef;
            position: relative;
            overflow: hidden;
        }
        
        #waveformCanvas {
            width: 100%;
            height: 120px;
            border-radius: 8px;
            background: #ffffff;
            border: 2px solid #e0e0e0;
            display: block;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        #waveformText {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
            font-family: monospace;
            display: none; /* é»˜è®¤éšè—å ä½æ–‡æœ¬ */
        }

        .waveform.active {
            background: linear-gradient(90deg, #4facfe, #00f2fe, #4facfe);
            background-size: 200% 100%;
            animation: waveAnimation 2s linear infinite;
        }

        @keyframes waveAnimation {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: 600;
            color: #4facfe;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .history-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #4facfe;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .history-date {
            color: #666;
            font-size: 0.9em;
        }

        .history-category {
            background: #4facfe;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .history-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .history-score {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .history-score-value {
            font-size: 1.3em;
            font-weight: 600;
            color: #4facfe;
        }

        .history-score-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 2px;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9em;
        }

        /* é¢˜ç›®æ˜¾ç¤ºæ ·å¼ */
        .question-display {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .question-content {
            font-size: 1.1em;
            line-height: 1.6;
            color: #333;
        }

        .question-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #4facfe;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .question-tips {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .question-tips ul {
            margin: 0;
            padding-left: 0;
        }

        .question-tips li {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #4facfe;
            list-style: none;
        }

        .topic-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .recording-section {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
            
            .score-overview {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .feedback-section {
                grid-template-columns: 1fr;
            }

            .history-scores {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– IELTS Speaking Practice</h1>
            <p>AIæ™ºèƒ½ç‰ˆ - è¯­éŸ³è¯†åˆ« + æ™ºèƒ½è¯„åˆ†</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('record')">ğŸ™ï¸ æ™ºèƒ½å½•éŸ³</button>
            <button class="tab" onclick="switchTab('analysis')">ğŸ“Š AIåˆ†æ</button>
            <button class="tab" onclick="switchTab('history')">ğŸ“š å†å²è®°å½•</button>
        </div>

        <div class="content">
            <!-- æ™ºèƒ½å½•éŸ³æ ‡ç­¾é¡µ -->
            <div id="record-tab" class="tab-content active">
                <div class="recording-section">
                    <div class="recording-controls">
                        <div class="category-selector">
                            <label for="category">é€‰æ‹©ç»ƒä¹ ç±»åˆ«ï¼š</label>
                            <select id="category" onchange="app.onCategoryChange()">
                                <option value="Part 1">Part 1 - æ—¥å¸¸è¯é¢˜</option>
                                <option value="Part 2">Part 2 - è¯é¢˜æè¿°</option>
                                <option value="Part 3">Part 3 - æ·±åº¦è®¨è®º</option>
                                <option value="Practice">Practice - è‡ªç”±ç»ƒä¹ </option>
                            </select>
                        </div>
                        
                        <!-- é¢˜ç›®é€‰æ‹©åŒºåŸŸ -->
                        <div class="question-selector" style="margin: 20px 0;">
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button class="btn btn-secondary" onclick="app.getRandomQuestion()" style="flex: 1;">
                                    ğŸ² éšæœºé¢˜ç›®
                                </button>
                                <button class="btn btn-secondary" onclick="app.showTopicSelector()" style="flex: 1;">
                                    ğŸ“š é€‰æ‹©è¯é¢˜
                                </button>
                            </div>
                            
                            <!-- è¯é¢˜é€‰æ‹©å™¨ -->
                            <div id="topicSelector" style="display: none; margin-bottom: 15px;">
                                <label for="topicSelect">é€‰æ‹©è¯é¢˜:</label>
                                <select id="topicSelect" onchange="app.onTopicChange()">
                                    <option value="">è¯·é€‰æ‹©è¯é¢˜</option>
                                </select>
                            </div>
                            
                            <!-- å½“å‰é¢˜ç›®æ˜¾ç¤º -->
                            <div id="currentQuestion" class="question-display">
                                <div style="text-align: center; color: #666; padding: 20px;">
                                    <div style="font-size: 2em; margin-bottom: 10px;">ğŸ¯</div>
                                    <p>ç‚¹å‡»"éšæœºé¢˜ç›®"å¼€å§‹ç»ƒä¹ ï¼Œæˆ–é€‰æ‹©ç‰¹å®šè¯é¢˜</p>
                                </div>
                            </div>
                            
                            <!-- ç­”é¢˜æŠ€å·§ -->
                            <div id="questionTips" style="display: none;" class="question-tips">
                                <h4 style="color: #4facfe; margin-bottom: 10px;">ğŸ’¡ ç­”é¢˜æŠ€å·§</h4>
                                <ul id="tipsList" style="margin-left: 20px; color: #666;">
                                </ul>
                            </div>
                        </div>

                        <button id="recordBtn" class="record-btn" onclick="toggleRecording()">
                            ğŸ™ï¸ å¼€å§‹å½•éŸ³
                        </button>

                        <div class="timer" id="timer">00:00</div>

                        <div class="speech-status">
                            <div class="status-indicator" id="speechIndicator"></div>
                            <span id="speechStatus">å‡†å¤‡å¼€å§‹è¯­éŸ³è¯†åˆ«</span>
                        </div>

                        <div class="waveform" id="waveform">
                            <canvas id="waveformCanvas" width="600" height="120"></canvas>
                            <div id="waveformText" style="color: #999; text-align: center; padding: 20px;">ğŸµ å®æ—¶éŸ³é¢‘æ³¢å½¢æ˜¾ç¤º</div>
                        </div>
                    </div>

                    <div class="transcript-section">
                        <h3 style="margin-bottom: 15px;">ğŸ“ å®æ—¶è½¬å½•</h3>
                        <div id="transcriptDisplay" class="transcript-display">
                            <div style="color: #999; text-align: center; padding: 40px;">
                                å¼€å§‹å½•éŸ³åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºå®æ—¶è¯­éŸ³è½¬å½•...
                            </div>
                        </div>
                        
                        <div class="stats-grid" id="liveStats" style="margin-top: 20px; display: none;">
                            <div class="stat-item">
                                <div class="stat-number" id="wordCount">0</div>
                                <div class="stat-label">è¯æ•°</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="wpmDisplay">0</div>
                                <div class="stat-label">WPM</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="saveSection" class="save-section" style="display: none;">
                    <h3 style="margin-bottom: 15px;">ğŸ’¾ ä¿å­˜å½•éŸ³</h3>
                    <input type="text" id="recordingTitle" placeholder="è¾“å…¥å½•éŸ³æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰">
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveRecording()">ğŸ’¾ ä¿å­˜å¹¶åˆ†æ</button>
                        <button class="btn btn-secondary" onclick="discardRecording()">ğŸ—‘ï¸ ä¸¢å¼ƒå½•éŸ³</button>
                    </div>
                </div>
            </div>

            <!-- AIåˆ†ææ ‡ç­¾é¡µ -->
            <div id="analysis-tab" class="tab-content">
                <div id="analysisContent">
                    <div style="text-align: center; color: #666; padding: 60px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">ğŸ¤–</div>
                        <h3>AIæ™ºèƒ½åˆ†æ</h3>
                        <p>å®Œæˆå½•éŸ³åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºè¯¦ç»†çš„AIåˆ†ææŠ¥å‘Š</p>
                    </div>
                </div>
            </div>

            <!-- å†å²è®°å½•æ ‡ç­¾é¡µ -->
            <div id="history-tab" class="tab-content">
                <div id="historyContent">
                    <div class="history-controls" style="margin-bottom: 20px;">
                        <select id="historyFilter" onchange="app.filterHistory()" style="padding: 8px; margin-right: 10px;">
                            <option value="all">å…¨éƒ¨ç±»åˆ«</option>
                            <option value="Part 1">Part 1</option>
                            <option value="Part 2">Part 2</option>
                            <option value="Part 3">Part 3</option>
                            <option value="Practice">Practice</option>
                        </select>
                        <button class="btn btn-secondary" onclick="app.loadHistory()">ğŸ”„ åˆ·æ–°</button>
                        <button class="btn btn-danger" onclick="app.clearAllHistory()" style="float: right;">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
                    </div>
                    <div id="historyList">
                        <div style="text-align: center; color: #666; padding: 60px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“š</div>
                            <h3>å†å²è®°å½•</h3>
                            <p>æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="speech-recognition-module.js"></script>
    <script>
        class IELTSSpeakingAppAI {
            constructor() {
                this.db = null;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.isRecording = false;
                this.startTime = null;
                this.timerInterval = null;
                this.currentRecordingBlob = null;
                this.currentQuestion = null;
                
                // éŸ³é¢‘å¯è§†åŒ–ç›¸å…³
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                this.canvas = null;
                this.canvasCtx = null;
                this.animationFrame = null;
                this.waveformData = []; // å­˜å‚¨å†å²æ³¢å½¢æ•°æ®
                this.scrollOffset = 0;
                
                // AIåˆ†æå¼•æ“
                this.speechEngine = new SpeechAnalysisEngine();
                this.aiEngine = new AIAnalysisEngine();
                this.advancedEngine = new AdvancedAnalysisEngine();
                
                // é¢˜åº“ç³»ç»Ÿ
                this.questionBank = new IELTSQuestionBank();
                
                // ç»‘å®šè½¬å½•æ›´æ–°å›è°ƒ
                this.speechEngine.onTranscriptUpdate = (transcript, interim) => {
                    this.updateTranscriptDisplay(transcript, interim);
                };
                
                this.initDB();
                this.initQuestionBank();
                
                // å»¶è¿Ÿåˆå§‹åŒ–æ³¢å½¢æ˜¾ç¤ºï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
                setTimeout(() => {
                    this.initWaveformDisplay();
                }, 100);
            }

            // åˆå§‹åŒ–æ•°æ®åº“
            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('IELTSAppAI', 1);
                    
                    request.onerror = () => reject(request.error);
                    
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('æ•°æ®åº“è¿æ¥æˆåŠŸ');
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        if (db.objectStoreNames.contains('recordings')) {
                            db.deleteObjectStore('recordings');
                        }
                        
                        const recordingStore = db.createObjectStore('recordings', { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        
                        recordingStore.createIndex('category', 'category', { unique: false });
                        recordingStore.createIndex('date', 'date', { unique: false });
                        recordingStore.createIndex('score', 'analysis.overall', { unique: false });
                    };
                });
            }

            // å‘çˆ¶çª—å£å‘é€æ¶ˆæ¯
            sendMessageToParent(action, data = {}) {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'IELTS_APP_MESSAGE',
                        action: action,
                        data: data,
                        timestamp: Date.now()
                    }, '*');
                }
            }

            // å¼€å§‹å½•éŸ³
            async startRecording() {
                try {
                    // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Safari');
                        return;
                    }

                    if (!window.MediaRecorder) {
                        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒMediaRecorderï¼Œè¯·å‡çº§æµè§ˆå™¨');
                        return;
                    }

                    // å¯åŠ¨éŸ³é¢‘å½•åˆ¶
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 44100
                        } 
                    });
                    
                    // åˆå§‹åŒ–éŸ³é¢‘å¯è§†åŒ–
                    this.initAudioVisualization(stream);
                    
                    // æ£€æŸ¥æ”¯æŒçš„éŸ³é¢‘æ ¼å¼
                    let mimeType = 'audio/webm;codecs=opus';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/webm';
                        if (!MediaRecorder.isTypeSupported(mimeType)) {
                            mimeType = 'audio/mp4';
                            if (!MediaRecorder.isTypeSupported(mimeType)) {
                                mimeType = ''; // ä½¿ç”¨é»˜è®¤æ ¼å¼
                            }
                        }
                    }
                    
                    this.mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});
                    this.audioChunks = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.audioChunks, { 
                            type: mimeType || 'audio/webm' 
                        });
                        
                        if (audioBlob.size === 0) {
                            alert('å½•éŸ³å¤±è´¥ï¼šæ²¡æœ‰å½•åˆ¶åˆ°éŸ³é¢‘æ•°æ®');
                            return;
                        }
                        
                        this.currentRecordingBlob = audioBlob;
                        this.showSaveSection();
                        
                        // åœæ­¢éŸ³è½¨
                        stream.getTracks().forEach(track => track.stop());
                    };

                    this.mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorderé”™è¯¯:', event.error);
                        alert('å½•éŸ³è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + event.error);
                    };
                    
                    // å¯åŠ¨è¯­éŸ³è¯†åˆ«
                    if (this.speechEngine) {
                        this.speechEngine.onTranscriptUpdate = (transcript, interim) => {
                            this.updateTranscriptDisplay(transcript, interim);
                        };
                        
                        const speechStarted = this.speechEngine.startRecognition();
                        if (!speechStarted) {
                            console.warn('è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥ï¼Œå°†ç»§ç»­å½•éŸ³ä½†æ— æ³•æä¾›å®æ—¶è½¬å½•');
                        }
                    }
                    
                    this.mediaRecorder.start(1000); // æ¯ç§’æ”¶é›†ä¸€æ¬¡æ•°æ®
                    this.isRecording = true;
                    this.startTime = Date.now();
                    this.startTimer();
                    this.updateRecordingUI();
                    
                    // æ˜¾ç¤ºå®æ—¶ç»Ÿè®¡
                    document.getElementById('liveStats').style.display = 'grid';
                    
                    // é€šçŸ¥çˆ¶çª—å£å½•éŸ³å¼€å§‹
                    this.sendMessageToParent('RECORDING_STARTED', { 
                        startTime: this.startTime 
                    });
                    
                } catch (error) {
                    console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
                    let errorMessage = 'å½•éŸ³å¯åŠ¨å¤±è´¥: ';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage += 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage += 'éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨ï¼Œè¯·å…³é—­å…¶ä»–å½•éŸ³åº”ç”¨';
                    } else if (error.name === 'OverconstrainedError') {
                        errorMessage += 'éº¦å…‹é£ä¸æ”¯æŒè¯·æ±‚çš„éŸ³é¢‘æ ¼å¼';
                    } else {
                        errorMessage += error.message || 'æœªçŸ¥é”™è¯¯';
                    }
                    
                    alert(errorMessage);
                }
            }

            // åœæ­¢å½•éŸ³
            stopRecording() {
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                }
                
                this.speechEngine.stopRecognition();
                this.isRecording = false;
                this.stopTimer();
                this.updateRecordingUI();
                
                // åœæ­¢éŸ³é¢‘å¯è§†åŒ–
                this.stopAudioVisualization();
                
                // æ›´æ–°è¯­éŸ³çŠ¶æ€
                document.getElementById('speechStatus').textContent = 'å½•éŸ³å·²å®Œæˆ';
                document.getElementById('speechIndicator').classList.remove('active');
                
                // é€šçŸ¥çˆ¶çª—å£å½•éŸ³åœæ­¢
                this.sendMessageToParent('RECORDING_STOPPED', { 
                    endTime: Date.now(),
                    duration: Date.now() - this.startTime 
                });
            }

            // æ›´æ–°è½¬å½•æ˜¾ç¤º
            updateTranscriptDisplay(finalTranscript, interimTranscript) {
                const display = document.getElementById('transcriptDisplay');
                
                // æ˜¾ç¤ºæœ€ç»ˆæ–‡æœ¬å’Œä¸´æ—¶æ–‡æœ¬
                display.innerHTML = `
                    <div class="transcript-final" style="color: #333; line-height: 1.6;">${finalTranscript}</div>
                    <div class="transcript-interim" style="color: #999; font-style: italic; line-height: 1.6;">${interimTranscript}</div>
                `;

                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                display.scrollTop = display.scrollHeight;

                // æ›´æ–°å®æ—¶ç»Ÿè®¡
                const combinedText = finalTranscript + interimTranscript;
                if (combinedText.trim().length > 0) {
                    const words = combinedText.trim().split(/\s+/).filter(w => w.length > 0);
                    const duration = Date.now() - this.startTime;
                    const wpm = Math.round((words.length / duration) * 60000);
                    
                    document.getElementById('wordCount').textContent = words.length;
                    document.getElementById('wpmDisplay').textContent = wpm;
                }

                // æ›´æ–°è¯­éŸ³çŠ¶æ€
                if (interimTranscript.length > 0) {
                    document.getElementById('speechStatus').textContent = 'æ­£åœ¨è¯†åˆ«è¯­éŸ³...';
                    document.getElementById('speechIndicator').classList.add('active');
                } else if (finalTranscript.length > 0) {
                    document.getElementById('speechStatus').textContent = 'è¯­éŸ³è¯†åˆ«ä¸­';
                    document.getElementById('speechIndicator').classList.add('active');
                } else {
                    document.getElementById('speechStatus').textContent = 'ç­‰å¾…è¯­éŸ³è¾“å…¥';
                    document.getElementById('speechIndicator').classList.remove('active');
                }
            }

            // å¼€å§‹è®¡æ—¶å™¨
            startTimer() {
                this.timerInterval = setInterval(() => {
                    const elapsed = Date.now() - this.startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    document.getElementById('timer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            // åœæ­¢è®¡æ—¶å™¨
            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            // æ›´æ–°å½•éŸ³ç•Œé¢
            updateRecordingUI() {
                const recordBtn = document.getElementById('recordBtn');
                
                if (this.isRecording) {
                    recordBtn.textContent = 'â¹ï¸ åœæ­¢å½•éŸ³';
                    recordBtn.classList.add('recording');
                    // ä¸å†ä¿®æ”¹waveformå†…å®¹ï¼Œè®©Canvasæ­£å¸¸æ˜¾ç¤º
                } else {
                    recordBtn.textContent = 'ğŸ™ï¸ å¼€å§‹å½•éŸ³';
                    recordBtn.classList.remove('recording');
                    // å½•éŸ³åœæ­¢æ—¶é‡æ–°åˆå§‹åŒ–æ³¢å½¢æ˜¾ç¤º
                    setTimeout(() => {
                        this.initWaveformDisplay();
                    }, 100);
                }
            }

            // æ˜¾ç¤ºä¿å­˜åŒºåŸŸ
            showSaveSection() {
                document.getElementById('saveSection').style.display = 'block';
                const category = document.getElementById('category').value;
                const now = new Date();
                const dateStr = now.toLocaleDateString('zh-CN');
                const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                
                document.getElementById('recordingTitle').value = 
                    `${category} - ${dateStr} ${timeStr}`;
            }

            // ä¿å­˜å½•éŸ³å¹¶è¿›è¡ŒAIåˆ†æ
            async saveRecording() {
                const title = document.getElementById('recordingTitle').value.trim();
                const category = document.getElementById('category').value;
                
                if (!this.currentRecordingBlob) {
                    alert('æ²¡æœ‰å¯ä¿å­˜çš„å½•éŸ³ï¼Œè¯·å…ˆå½•åˆ¶éŸ³é¢‘');
                    return;
                }

                try {
                    // æ˜¾ç¤ºä¿å­˜è¿›åº¦
                    const saveBtn = document.querySelector('.btn-primary');
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = 'æ­£åœ¨ä¿å­˜...';
                    saveBtn.disabled = true;

                    // è·å–è¯­éŸ³ç»Ÿè®¡æ•°æ®
                    let speechStats;
                    try {
                        speechStats = this.speechEngine ? this.speechEngine.calculateSpeechStats() : {
                            duration: Date.now() - this.startTime,
                            wordCount: 0,
                            wpm: 0,
                            transcript: document.getElementById('transcriptDisplay').textContent || '',
                            pauseCount: 0
                        };
                        console.log('è¯­éŸ³ç»Ÿè®¡æ•°æ®:', speechStats);
                    } catch (error) {
                        console.warn('è·å–è¯­éŸ³ç»Ÿè®¡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', error);
                        speechStats = {
                            duration: Date.now() - this.startTime,
                            wordCount: 0,
                            wpm: 0,
                            transcript: 'è¯­éŸ³è¯†åˆ«å¼‚å¸¸',
                            pauseCount: 0
                        };
                    }
                    
                    // è¿›è¡Œé«˜çº§AIåˆ†æ
                    let analysis;
                    try {
                        // ä¼˜å…ˆä½¿ç”¨é«˜çº§åˆ†æå¼•æ“
                        analysis = await this.advancedEngine.analyzeRecordingAdvanced(speechStats, this.currentQuestion?.type || 'Practice', category);
                        console.log('é«˜çº§AIåˆ†æå®Œæˆ:', analysis);
                    } catch (error) {
                        console.warn('é«˜çº§åˆ†æå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€åˆ†æ:', error);
                        try {
                            analysis = await this.aiEngine.analyzeRecording(speechStats, category);
                            console.log('åŸºç¡€AIåˆ†æå®Œæˆ:', analysis);
                        } catch (fallbackError) {
                            console.warn('æ‰€æœ‰åˆ†æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ:', fallbackError);
                            analysis = {
                                overall: 5.0,
                                detailedScores: {
                                    fluency: { score: 5.0, wpm: speechStats.wpm || 0 },
                                    vocabulary: { score: 5.0, uniqueWords: 0, diversity: 0 },
                                    grammar: { score: 5.0, sentenceCount: 0, avgSentenceLength: 0 },
                                    pronunciation: { score: 5.0, clarity: 'unknown' }
                                },
                                strengths: ['å®Œæˆäº†å½•éŸ³ç»ƒä¹ '],
                                improvements: [{ area: 'ç³»ç»Ÿ', suggestion: 'AIåˆ†æåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•' }]
                            };
                        }
                    }
                    
                    // æ£€æŸ¥å­˜å‚¨ç©ºé—´
                    if (this.currentRecordingBlob.size > 10 * 1024 * 1024) { // 10MBé™åˆ¶
                        throw new Error('å½•éŸ³æ–‡ä»¶è¿‡å¤§ï¼Œè¯·å½•åˆ¶è¾ƒçŸ­çš„éŸ³é¢‘');
                    }
                    
                    // å‡†å¤‡å­˜å‚¨æ•°æ®
                    const reader = new FileReader();
                    
                    const recordingData = await new Promise((resolve, reject) => {
                        reader.onload = () => {
                            resolve({
                                id: Date.now(),
                                title: title || `${category} - ${new Date().toLocaleString('zh-CN')}`,
                                category: category,
                                date: new Date().toISOString(),
                                duration: speechStats.duration,
                                audioData: reader.result, // ä½¿ç”¨base64æ ¼å¼è€Œä¸æ˜¯ArrayBuffer
                                mimeType: 'audio/webm;codecs=opus',
                                size: Math.round(this.currentRecordingBlob.size / 1024), // KB
                                transcript: speechStats.transcript,
                                analysis: analysis,
                                speechStats: speechStats,
                                // ä¿å­˜å½“å‰é¢˜ç›®ä¿¡æ¯
                                question: this.currentQuestion ? {
                                    topic: this.currentQuestion.topic,
                                    question: this.currentQuestion.question,
                                    category: this.currentQuestion.category
                                } : null
                            });
                        };
                        reader.onerror = () => reject(new Error('è¯»å–éŸ³é¢‘æ–‡ä»¶å¤±è´¥'));
                        reader.readAsDataURL(this.currentRecordingBlob);
                    });

                    // ä¿å­˜åˆ°IndexedDB
                    await this.saveRecordingToDB(recordingData);
                    console.log('å½•éŸ³ä¿å­˜åˆ°æ•°æ®åº“æˆåŠŸ');
                    
                    // æ˜¾ç¤ºåˆ†æç»“æœ
                    try {
                        this.displayAnalysis(analysis, speechStats);
                        console.log('åˆ†æç»“æœæ˜¾ç¤ºæˆåŠŸ');
                        
                        // åˆ‡æ¢åˆ°åˆ†ææ ‡ç­¾é¡µ
                        switchTab('analysis');
                        console.log('æ ‡ç­¾é¡µåˆ‡æ¢æˆåŠŸ');
                        
                        // é€šçŸ¥çˆ¶çª—å£åˆ†æå®Œæˆ
                        this.sendMessageToParent('ANALYSIS_COMPLETED', { 
                            overallScore: analysis.overall,
                            analysisTime: Date.now()
                        });
                    } catch (error) {
                        console.warn('æ˜¾ç¤ºåˆ†æç»“æœå¤±è´¥:', error);
                    }
                    
                    alert(`å½•éŸ³ä¿å­˜æˆåŠŸï¼æ–‡ä»¶å¤§å°: ${recordingData.size}KBï¼ŒAIåˆ†æå·²å®Œæˆï¼`);
                    this.discardRecording();
                    
                    // å¦‚æœå½“å‰åœ¨å†å²è®°å½•é¡µé¢ï¼Œåˆ·æ–°å†å²è®°å½•
                    if (document.getElementById('history-tab').classList.contains('active')) {
                        this.loadHistory();
                    }
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    
                } catch (error) {
                    console.error('ä¿å­˜å½•éŸ³å¤±è´¥:', error);
                    alert('ä¿å­˜å½•éŸ³å¤±è´¥: ' + error.message);
                    
                    // é€šçŸ¥çˆ¶çª—å£å‘ç”Ÿé”™è¯¯
                    this.sendMessageToParent('ERROR', { 
                        message: error.message,
                        errorTime: Date.now()
                    });
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    const saveBtn = document.querySelector('.btn-primary');
                    saveBtn.textContent = 'ğŸ’¾ ä¿å­˜å¹¶åˆ†æ';
                    saveBtn.disabled = false;
                }
            }

            // ä¿å­˜åˆ°æ•°æ®åº“
            async saveRecordingToDB(recordingData) {
                return new Promise((resolve, reject) => {
                    try {
                        // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²åˆå§‹åŒ–
                        if (!this.db) {
                            reject(new Error('æ•°æ®åº“æœªåˆå§‹åŒ–'));
                            return;
                        }

                        // æ•°æ®åº“è¿æ¥çŠ¶æ€æ£€æŸ¥ï¼ˆreadyStateå¯èƒ½ä¸å­˜åœ¨ï¼‰
                        console.log('æ•°æ®åº“çŠ¶æ€:', this.db.readyState);
                        // ç§»é™¤ä¸¥æ ¼çš„çŠ¶æ€æ£€æŸ¥ï¼Œå› ä¸ºreadyStateå¯èƒ½ä¸ºundefinedä½†æ•°æ®åº“ä»å¯ç”¨

                        const transaction = this.db.transaction(['recordings'], 'readwrite');
                        
                        transaction.onerror = () => {
                            reject(new Error('æ•°æ®åº“äº‹åŠ¡åˆ›å»ºå¤±è´¥: ' + transaction.error));
                        };

                        const store = transaction.objectStore('recordings');
                        const request = store.add(recordingData);
                        
                        request.onsuccess = () => {
                            console.log('å½•éŸ³ä¿å­˜æˆåŠŸï¼ŒID:', request.result);
                            resolve(request.result);
                        };
                        
                        request.onerror = () => {
                            console.error('ä¿å­˜å½•éŸ³å¤±è´¥:', request.error);
                            reject(new Error('ä¿å­˜å½•éŸ³å¤±è´¥: ' + request.error));
                        };

                    } catch (error) {
                        console.error('saveRecordingToDB å¼‚å¸¸:', error);
                        reject(new Error('æ•°æ®åº“æ“ä½œå¼‚å¸¸: ' + error.message));
                    }
                });
            }

            // æ˜¾ç¤ºAIåˆ†æç»“æœ
            displayAnalysis(analysis, speechStats) {
                const content = document.getElementById('analysisContent');
                
                const getScoreClass = (score) => {
                    if (score >= 8) return 'excellent';
                    if (score >= 7) return 'good';
                    if (score >= 6) return 'average';
                    return 'poor';
                };

                // å…¼å®¹é«˜çº§åˆ†æå¼•æ“å’ŒåŸºç¡€åˆ†æå¼•æ“çš„æ•°æ®ç»“æ„
                const scores = analysis.detailedScores || {
                    fluency: analysis.fluency,
                    vocabulary: analysis.vocabulary,
                    grammar: analysis.grammar,
                    pronunciation: analysis.pronunciation
                };

                content.innerHTML = `
                    <div class="analysis-section">
                        <h2 style="margin-bottom: 30px; text-align: center;">ğŸ¤– AIæ™ºèƒ½åˆ†ææŠ¥å‘Š</h2>
                        
                        <div class="score-overview">
                            <div class="score-card">
                                <div class="score-value ${getScoreClass(analysis.overall)}">${analysis.overall.toFixed(1)}<span style="font-size: 0.6em; color: #666;">/9.0</span></div>
                                <div class="score-label">æ€»åˆ†</div>
                                <div class="score-details">IELTSå£è¯­è¯„åˆ†</div>
                            </div>
                            <div class="score-card">
                                <div class="score-value ${getScoreClass(scores.fluency.score)}">${scores.fluency.score.toFixed(1)}<span style="font-size: 0.6em; color: #666;">/9.0</span></div>
                                <div class="score-label">æµç•…åº¦ä¸è¿è´¯æ€§</div>
                                <div class="score-details">${scores.fluency.wpm || scores.fluency.details?.speechRate || 0} WPM</div>
                            </div>
                            <div class="score-card">
                                <div class="score-value ${getScoreClass(scores.vocabulary.score)}">${scores.vocabulary.score.toFixed(1)}<span style="font-size: 0.6em; color: #666;">/9.0</span></div>
                                <div class="score-label">è¯æ±‡èµ„æº</div>
                                <div class="score-details">${scores.vocabulary.uniqueWords || scores.vocabulary.details?.vocabularyRange || 0} ä¸ªä¸åŒè¯æ±‡</div>
                            </div>
                            <div class="score-card">
                                <div class="score-value ${getScoreClass(scores.grammar.score)}">${scores.grammar.score.toFixed(1)}<span style="font-size: 0.6em; color: #666;">/9.0</span></div>
                                <div class="score-label">è¯­æ³•èŒƒå›´ä¸å‡†ç¡®æ€§</div>
                                <div class="score-details">${scores.grammar.sentenceCount || scores.grammar.details?.complexity || 0} ä¸ªå¥å­</div>
                            </div>
                            <div class="score-card">
                                <div class="score-value ${getScoreClass(scores.pronunciation.score)}">${scores.pronunciation.score.toFixed(1)}<span style="font-size: 0.6em; color: #666;">/9.0</span></div>
                                <div class="score-label">å‘éŸ³</div>
                                <div class="score-details">${scores.pronunciation.clarity || scores.pronunciation.details?.clarity || 'unknown'}</div>
                            </div>
                        </div>

                        <div class="feedback-section">
                            <div class="feedback-card">
                                <div class="feedback-title">
                                    ğŸ’ª æ‚¨çš„ä¼˜åŠ¿
                                </div>
                                <ul class="feedback-list">
                                    ${(analysis.strengths || []).map(strength => `<li>${strength}</li>`).join('')}
                                    ${(!analysis.strengths || analysis.strengths.length === 0) ? '<li>ç»§ç»­åŠªåŠ›ï¼Œæ‚¨æ­£åœ¨è¿›æ­¥ä¸­ï¼</li>' : ''}
                                </ul>
                            </div>

                            <div class="feedback-card">
                                <div class="feedback-title">
                                    ğŸ¯ æ”¹è¿›å»ºè®®
                                </div>
                                <ul class="feedback-list">
                                    ${(analysis.improvements || []).map(improvement => `
                                        <li>
                                            <strong>${improvement.area || 'å»ºè®®'}:</strong> ${improvement.suggestion || improvement}
                                        </li>
                                    `).join('')}
                                    ${(!analysis.improvements || analysis.improvements.length === 0) ? '<li>ç»§ç»­ä¿æŒè‰¯å¥½è¡¨ç°ï¼</li>' : ''}
                                </ul>
                            </div>

                            <div class="feedback-card">
                                <div class="feedback-title">
                                    ğŸ“Š è¯¦ç»†åˆ†æ
                                </div>
                                <ul class="feedback-list">
                                    <li><strong>æ€»è¯æ•°:</strong> ${speechStats.wordCount} è¯</li>
                                    <li><strong>è¯­é€Ÿ:</strong> ${scores.fluency.wpm || scores.fluency.details?.speechRate || 0} è¯/åˆ†é’Ÿ</li>
                                    <li><strong>è¯æ±‡å¤šæ ·æ€§:</strong> ${((scores.vocabulary.diversity || 0) * 100).toFixed(1)}%</li>
                                    <li><strong>å¹³å‡å¥é•¿:</strong> ${(scores.grammar.avgSentenceLength || scores.grammar.averageWordsPerSentence || 0).toFixed(1)} è¯</li>
                                    <li><strong>å½•éŸ³æ—¶é•¿:</strong> ${this.formatDuration(speechStats.duration)}</li>
                                    ${analysis.bandDescriptors ? `<li><strong>é›…æ€åˆ†æ•°æ®µ:</strong> Band ${analysis.bandDescriptors.band} - ${analysis.bandDescriptors.description}</li>` : ''}
                                </ul>
                            </div>

                            <div class="feedback-card">
                                <div class="feedback-title">
                                    ğŸ“ è½¬å½•æ–‡æœ¬
                                </div>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.6; max-height: 200px; overflow-y: auto;">
                                    ${speechStats.transcript || 'æœªæ£€æµ‹åˆ°è¯­éŸ³å†…å®¹'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ä¸¢å¼ƒå½•éŸ³
            discardRecording() {
                this.currentRecordingBlob = null;
                document.getElementById('saveSection').style.display = 'none';
                document.getElementById('recordingTitle').value = '';
                document.getElementById('timer').textContent = '00:00';
                document.getElementById('transcriptDisplay').innerHTML = `
                    <div style="color: #999; text-align: center; padding: 40px;">
                        å¼€å§‹å½•éŸ³åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºå®æ—¶è¯­éŸ³è½¬å½•...
                    </div>
                `;
                document.getElementById('liveStats').style.display = 'none';
                document.getElementById('speechStatus').textContent = 'å‡†å¤‡å¼€å§‹è¯­éŸ³è¯†åˆ«';
                document.getElementById('speechIndicator').classList.remove('active');
            }

            // æ ¼å¼åŒ–æ—¶é•¿
            formatDuration(milliseconds) {
                const seconds = Math.floor(milliseconds / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            // åŠ è½½å†å²è®°å½•
            async loadHistory() {
                try {
                    console.log('å¼€å§‹åŠ è½½å†å²è®°å½•...');
                    const recordings = await this.getAllRecordings();
                    console.log('è·å–åˆ°å†å²è®°å½•æ•°é‡:', recordings.length);
                    
                    // éªŒè¯è®°å½•æ•°æ®ç»“æ„
                    recordings.forEach((recording, index) => {
                        if (recording.analysis) {
                            console.log(`è®°å½• ${index + 1} åˆ†ææ•°æ®:`, recording.analysis);
                            // æ£€æŸ¥åˆ†ææ•°æ®æ˜¯å¦æœ‰é—®é¢˜
                            if (!recording.analysis.overall && recording.analysis.overall !== 0) {
                                console.warn(`è®°å½• ${index + 1} ç¼ºå°‘ overall åˆ†æ•°`);
                            }
                        }
                    });
                    
                    this.displayHistory(recordings);
                    console.log('å†å²è®°å½•æ˜¾ç¤ºå®Œæˆ');
                } catch (error) {
                    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                    
                    document.getElementById('historyList').innerHTML = `
                        <div style="text-align: center; color: #666; padding: 60px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">âŒ</div>
                            <h3>åŠ è½½å¤±è´¥</h3>
                            <p>æ— æ³•åŠ è½½å†å²è®°å½•: ${error.message}</p>
                            <details style="margin: 20px 0; text-align: left; max-width: 500px;">
                                <summary style="cursor: pointer; color: #4facfe;">æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px; overflow: auto; max-height: 200px; margin-top: 10px;">${error.stack || error.message}</pre>
                            </details>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="app.loadHistory()" style="margin-right: 10px;">é‡è¯•</button>
                                <button class="btn btn-secondary" onclick="app.clearAllHistory()">æ¸…ç©ºæ•°æ®åº“</button>
                            </div>
                        </div>
                    `;
                }
            }

            // è·å–æ‰€æœ‰å½•éŸ³è®°å½•
            async getAllRecordings() {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('æ•°æ®åº“æœªåˆå§‹åŒ–'));
                        return;
                    }

                    const transaction = this.db.transaction(['recordings'], 'readonly');
                    const store = transaction.objectStore('recordings');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const recordings = request.result.sort((a, b) => new Date(b.date) - new Date(a.date));
                        resolve(recordings);
                    };

                    request.onerror = () => {
                        reject(new Error('è·å–å½•éŸ³è®°å½•å¤±è´¥'));
                    };
                });
            }

            // è·å–å…¼å®¹çš„åˆ†ææ•°æ®
            getCompatibleAnalysisData(analysis) {
                if (!analysis) return null;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯é«˜çº§åˆ†æå¼•æ“çš„æ ¼å¼ (æœ‰ detailedScores)
                if (analysis.detailedScores) {
                    return {
                        overall: analysis.overall || 0,
                        fluency: analysis.detailedScores.fluency || { score: 0 },
                        vocabulary: analysis.detailedScores.vocabulary || { score: 0 },
                        grammar: analysis.detailedScores.grammar || { score: 0 },
                        pronunciation: analysis.detailedScores.pronunciation || { score: 0 }
                    };
                }
                
                // åŸºç¡€åˆ†æå¼•æ“çš„æ ¼å¼
                return {
                    overall: analysis.overall || 0,
                    fluency: analysis.fluency || { score: 0 },
                    vocabulary: analysis.vocabulary || { score: 0 },
                    grammar: analysis.grammar || { score: 0 },
                    pronunciation: analysis.pronunciation || { score: 0 }
                };
            }

            // æ˜¾ç¤ºå†å²è®°å½•
            displayHistory(recordings) {
                const historyList = document.getElementById('historyList');
                
                if (recordings.length === 0) {
                    historyList.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 60px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“š</div>
                            <h3>æš‚æ— å†å²è®°å½•</h3>
                            <p>å¼€å§‹å½•åˆ¶æ‚¨çš„ç¬¬ä¸€ä¸ªIELTSå£è¯­ç»ƒä¹ å§ï¼</p>
                        </div>
                    `;
                    return;
                }

                const currentFilter = document.getElementById('historyFilter').value;
                const filteredRecordings = currentFilter === 'all' 
                    ? recordings 
                    : recordings.filter(r => r.category === currentFilter);

                if (filteredRecordings.length === 0) {
                    historyList.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 60px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">ğŸ”</div>
                            <h3>æœªæ‰¾åˆ°è®°å½•</h3>
                            <p>å½“å‰åˆ†ç±»ä¸‹æš‚æ— å½•éŸ³è®°å½•</p>
                        </div>
                    `;
                    return;
                }

                try {
                    historyList.innerHTML = filteredRecordings.map((recording, index) => {
                        try {
                            // è·å–å…¼å®¹çš„åˆ†ææ•°æ®
                            const analysisData = this.getCompatibleAnalysisData(recording.analysis);
                            
                            // å®‰å…¨è·å–æ ‡é¢˜å’Œæ—¥æœŸ
                            const title = recording.title || `å½•éŸ³ ${recording.id || index + 1}`;
                            const date = recording.date ? new Date(recording.date).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
                            const category = recording.category || 'æœªåˆ†ç±»';
                            
                            return `
                                <div class="history-item">
                                    <div class="history-header">
                                        <div>
                                            <div class="history-title">${title}</div>
                                            <div class="history-date">${date}</div>
                                            ${recording.question && recording.question.question ? `
                                                <div style="margin-top: 8px; padding: 8px; background: #f0f8ff; border-left: 3px solid #4facfe; border-radius: 4px;">
                                                    <div style="font-size: 0.9em; color: #666; margin-bottom: 4px;">ç»ƒä¹ é¢˜ç›®:</div>
                                                    <div style="font-size: 0.95em; color: #333;">${recording.question.question}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="history-category">${category}</div>
                                    </div>
                                    
                                    ${analysisData ? `
                                        <div class="history-scores">
                                            <div class="history-score">
                                                <div class="history-score-value">${(analysisData.overall || 0).toFixed(1)}<span style="font-size: 0.7em; color: #888;">/9.0</span></div>
                                                <div class="history-score-label">æ€»åˆ†</div>
                                            </div>
                                            <div class="history-score">
                                                <div class="history-score-value">${(analysisData.fluency?.score || 0).toFixed(1)}<span style="font-size: 0.7em; color: #888;">/9.0</span></div>
                                                <div class="history-score-label">æµç•…åº¦</div>
                                            </div>
                                            <div class="history-score">
                                                <div class="history-score-value">${(analysisData.vocabulary?.score || 0).toFixed(1)}<span style="font-size: 0.7em; color: #888;">/9.0</span></div>
                                                <div class="history-score-label">è¯æ±‡</div>
                                            </div>
                                            <div class="history-score">
                                                <div class="history-score-value">${(analysisData.grammar?.score || 0).toFixed(1)}<span style="font-size: 0.7em; color: #888;">/9.0</span></div>
                                                <div class="history-score-label">è¯­æ³•</div>
                                            </div>
                                            <div class="history-score">
                                                <div class="history-score-value">${(analysisData.pronunciation?.score || 0).toFixed(1)}<span style="font-size: 0.7em; color: #888;">/9.0</span></div>
                                                <div class="history-score-label">å‘éŸ³</div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="color: #999; font-style: italic; text-align: center; padding: 10px;">
                                            æš‚æ— åˆ†ææ•°æ®
                                        </div>
                                    `}
                                    
                                    <div style="margin: 15px 0; color: #666; font-size: 0.9em;">
                                        <span>ğŸ“Š æ—¶é•¿: ${this.formatDuration(recording.duration || 0)}</span>
                                        <span style="margin-left: 20px;">ğŸ“ ${recording.speechStats?.wordCount || 0} è¯</span>
                                        <span style="margin-left: 20px;">ğŸ’¾ ${recording.size || 0}KB</span>
                                    </div>
                                    
                                    <div class="history-actions">
                                        <button class="btn btn-secondary btn-small" onclick="app.playHistoryRecording(${recording.id})">
                                            ğŸµ æ’­æ”¾
                                        </button>
                                        <button class="btn btn-secondary btn-small" onclick="app.viewHistoryAnalysis(${recording.id})">
                                            ğŸ“Š æŸ¥çœ‹åˆ†æ
                                        </button>
                                        <button class="btn btn-secondary btn-small" onclick="app.viewHistoryTranscript(${recording.id})">
                                            ğŸ“ æŸ¥çœ‹è½¬å½•
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="app.deleteHistoryRecording(${recording.id})">
                                            ğŸ—‘ï¸ åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                            `;
                        } catch (itemError) {
                            console.error(`æ¸²æŸ“å†å²è®°å½•é¡¹ ${index + 1} å¤±è´¥:`, itemError, recording);
                            return `
                                <div class="history-item" style="border: 2px solid #ff6b6b; background: #fff5f5;">
                                    <div class="history-header">
                                        <div>
                                            <div class="history-title" style="color: #ff6b6b;">æ•°æ®é”™è¯¯çš„è®°å½•</div>
                                            <div class="history-date">ID: ${recording.id || 'unknown'}</div>
                                        </div>
                                        <div class="history-category" style="background: #ff6b6b;">é”™è¯¯</div>
                                    </div>
                                    <div style="padding: 15px; color: #666;">
                                        <p>æ­¤è®°å½•çš„æ•°æ®æ ¼å¼æœ‰é—®é¢˜ï¼Œæ— æ³•æ­£å¸¸æ˜¾ç¤ºã€‚</p>
                                        <p style="font-size: 0.9em; margin-top: 10px;">é”™è¯¯: ${itemError.message}</p>
                                    </div>
                                    <div class="history-actions">
                                        <button class="btn btn-danger btn-small" onclick="app.deleteHistoryRecording(${recording.id})">
                                            ğŸ—‘ï¸ åˆ é™¤æŸåçš„è®°å½•
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                } catch (renderError) {
                    console.error('æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨å¤±è´¥:', renderError);
                    historyList.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 60px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">âŒ</div>
                            <h3>æ¸²æŸ“å¤±è´¥</h3>
                            <p>å†å²è®°å½•æ•°æ®å­˜åœ¨é—®é¢˜: ${renderError.message}</p>
                            <button class="btn btn-secondary" onclick="app.clearAllHistory()" style="margin-top: 20px;">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                        </div>
                    `;
                }
            }

            // ç­›é€‰å†å²è®°å½•
            filterHistory() {
                this.loadHistory();
            }

            // æ’­æ”¾å†å²å½•éŸ³
            async playHistoryRecording(id) {
                try {
                    const recording = await this.getRecordingById(id);
                    if (!recording || !recording.audioData) {
                        alert('å½•éŸ³æ•°æ®ä¸å­˜åœ¨');
                        return;
                    }

                    // åˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨
                    const audio = new Audio(recording.audioData);
                    audio.play();
                    
                    // æ˜¾ç¤ºæ’­æ”¾çŠ¶æ€
                    const playBtn = event.target;
                    const originalText = playBtn.textContent;
                    playBtn.textContent = 'â¸ï¸ æ’­æ”¾ä¸­...';
                    playBtn.disabled = true;
                    
                    audio.onended = () => {
                        playBtn.textContent = originalText;
                        playBtn.disabled = false;
                    };
                    
                    audio.onerror = () => {
                        playBtn.textContent = originalText;
                        playBtn.disabled = false;
                        alert('æ’­æ”¾å¤±è´¥');
                    };
                    
                } catch (error) {
                    console.error('æ’­æ”¾å½•éŸ³å¤±è´¥:', error);
                    alert('æ’­æ”¾å¤±è´¥: ' + error.message);
                }
            }

            // æŸ¥çœ‹å†å²åˆ†æ
            async viewHistoryAnalysis(id) {
                try {
                    const recording = await this.getRecordingById(id);
                    if (!recording || !recording.analysis) {
                        alert('åˆ†ææ•°æ®ä¸å­˜åœ¨');
                        return;
                    }

                    // æ˜¾ç¤ºåˆ†æç»“æœ
                    this.displayAnalysis(recording.analysis, recording.speechStats);
                    switchTab('analysis');
                    
                } catch (error) {
                    console.error('æŸ¥çœ‹åˆ†æå¤±è´¥:', error);
                    alert('æŸ¥çœ‹åˆ†æå¤±è´¥: ' + error.message);
                }
            }

            // æŸ¥çœ‹å†å²è½¬å½•
            async viewHistoryTranscript(id) {
                try {
                    const recording = await this.getRecordingById(id);
                    if (!recording) {
                        alert('å½•éŸ³æ•°æ®ä¸å­˜åœ¨');
                        return;
                    }

                    const transcript = recording.transcript || 'æ— è½¬å½•æ–‡æœ¬';
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                        background: rgba(0,0,0,0.5); z-index: 1000;
                        display: flex; align-items: center; justify-content: center;
                        padding: 20px;
                    `;
                    
                    modal.innerHTML = `
                        <div style="
                            background: white; border-radius: 12px; padding: 30px;
                            max-width: 600px; width: 100%; max-height: 80vh;
                            overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        ">
                            <h3 style="margin-bottom: 20px; color: #333;">ğŸ“ è½¬å½•æ–‡æœ¬</h3>
                            <div style="
                                background: #f8f9fa; padding: 20px; border-radius: 8px;
                                line-height: 1.6; max-height: 400px; overflow-y: auto;
                                border: 1px solid #e9ecef;
                            ">${transcript}</div>
                            <div style="text-align: right; margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    modal.onclick = (e) => {
                        if (e.target === modal) modal.remove();
                    };
                    
                } catch (error) {
                    console.error('æŸ¥çœ‹è½¬å½•å¤±è´¥:', error);
                    alert('æŸ¥çœ‹è½¬å½•å¤±è´¥: ' + error.message);
                }
            }

            // åˆ é™¤å†å²å½•éŸ³
            async deleteHistoryRecording(id) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå½•éŸ³å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    return;
                }

                try {
                    await this.deleteRecordingById(id);
                    this.loadHistory(); // åˆ·æ–°åˆ—è¡¨
                    alert('åˆ é™¤æˆåŠŸ');
                } catch (error) {
                    console.error('åˆ é™¤å½•éŸ³å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            }

            // æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•
            async clearAllHistory() {
                if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    return;
                }

                try {
                    await this.clearAllRecordings();
                    this.loadHistory(); // åˆ·æ–°åˆ—è¡¨
                    alert('æ¸…ç©ºæˆåŠŸ');
                } catch (error) {
                    console.error('æ¸…ç©ºå†å²è®°å½•å¤±è´¥:', error);
                    alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
                }
            }

            // æ ¹æ®IDè·å–å½•éŸ³
            async getRecordingById(id) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('æ•°æ®åº“æœªåˆå§‹åŒ–'));
                        return;
                    }

                    const transaction = this.db.transaction(['recordings'], 'readonly');
                    const store = transaction.objectStore('recordings');
                    const request = store.get(id);

                    request.onsuccess = () => {
                        resolve(request.result);
                    };

                    request.onerror = () => {
                        reject(new Error('è·å–å½•éŸ³å¤±è´¥'));
                    };
                });
            }

            // æ ¹æ®IDåˆ é™¤å½•éŸ³
            async deleteRecordingById(id) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('æ•°æ®åº“æœªåˆå§‹åŒ–'));
                        return;
                    }

                    const transaction = this.db.transaction(['recordings'], 'readwrite');
                    const store = transaction.objectStore('recordings');
                    const request = store.delete(id);

                    request.onsuccess = () => {
                        resolve();
                    };

                    request.onerror = () => {
                        reject(new Error('åˆ é™¤å½•éŸ³å¤±è´¥'));
                    };
                });
            }

            // æ¸…ç©ºæ‰€æœ‰å½•éŸ³
            async clearAllRecordings() {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('æ•°æ®åº“æœªåˆå§‹åŒ–'));
                        return;
                    }

                    const transaction = this.db.transaction(['recordings'], 'readwrite');
                    const store = transaction.objectStore('recordings');
                    const request = store.clear();

                    request.onsuccess = () => {
                        resolve();
                    };

                    request.onerror = () => {
                        reject(new Error('æ¸…ç©ºå½•éŸ³å¤±è´¥'));
                    };
                });
            }

            // === é¢˜åº“åŠŸèƒ½æ–¹æ³• ===
            
            // åˆå§‹åŒ–é¢˜åº“ç•Œé¢
            initQuestionBank() {
                try {
                    // åˆå§‹åŒ–ç±»åˆ«é€‰æ‹©å™¨
                    this.onCategoryChange();
                } catch (error) {
                    console.error('åˆå§‹åŒ–é¢˜åº“å¤±è´¥:', error);
                }
            }

            // ç±»åˆ«å˜åŒ–æ—¶æ›´æ–°è¯é¢˜é€‰æ‹©å™¨
            onCategoryChange() {
                try {
                    const category = document.getElementById('category').value;
                    const topicSelect = document.getElementById('topicSelect');
                    
                    if (!topicSelect || !this.questionBank) return;
                    
                    // æ¸…ç©ºè¯é¢˜é€‰æ‹©å™¨
                    topicSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¯é¢˜</option>';
                    
                    // è·å–å½“å‰ç±»åˆ«çš„è¯é¢˜
                    const topics = this.questionBank.getTopicsByCategory(category);
                    
                    topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic;
                        option.textContent = topic;
                        topicSelect.appendChild(option);
                    });
                    
                    // éšè—å½“å‰é¢˜ç›®
                    this.hideCurrentQuestion();
                    
                } catch (error) {
                    console.error('æ›´æ–°è¯é¢˜é€‰æ‹©å™¨å¤±è´¥:', error);
                }
            }

            // è·å–éšæœºé¢˜ç›®
            getRandomQuestion() {
                try {
                    const category = document.getElementById('category').value;
                    const question = this.questionBank.getRandomQuestion(category);
                    
                    if (question) {
                        this.currentQuestion = question;
                        this.displayQuestion(question);
                    } else {
                        alert('è¯¥ç±»åˆ«æš‚æ— é¢˜ç›®');
                    }
                } catch (error) {
                    console.error('è·å–éšæœºé¢˜ç›®å¤±è´¥:', error);
                    alert('è·å–é¢˜ç›®å¤±è´¥');
                }
            }

            // æ˜¾ç¤ºè¯é¢˜é€‰æ‹©å™¨
            showTopicSelector() {
                try {
                    const topicSelector = document.getElementById('topicSelector');
                    if (topicSelector) {
                        topicSelector.style.display = topicSelector.style.display === 'none' ? 'block' : 'none';
                    }
                } catch (error) {
                    console.error('æ˜¾ç¤ºè¯é¢˜é€‰æ‹©å™¨å¤±è´¥:', error);
                }
            }

            // è¯é¢˜å˜åŒ–æ—¶è·å–é¢˜ç›®
            onTopicChange() {
                try {
                    const category = document.getElementById('category').value;
                    const topic = document.getElementById('topicSelect').value;
                    
                    if (!topic) {
                        this.hideCurrentQuestion();
                        return;
                    }
                    
                    const question = this.questionBank.getQuestionByTopic(category, topic);
                    
                    if (question) {
                        this.currentQuestion = question;
                        this.displayQuestion(question);
                    } else {
                        alert('è¯¥è¯é¢˜æš‚æ— é¢˜ç›®');
                    }
                } catch (error) {
                    console.error('è·å–è¯é¢˜é¢˜ç›®å¤±è´¥:', error);
                    alert('è·å–é¢˜ç›®å¤±è´¥');
                }
            }

            // æ˜¾ç¤ºé¢˜ç›®
            displayQuestion(question) {
                try {
                    const questionDisplay = document.getElementById('currentQuestion');
                    const questionTips = document.getElementById('questionTips');
                    const tipsList = document.getElementById('tipsList');
                    
                    if (!questionDisplay) return;
                    
                    // æ˜¾ç¤ºé¢˜ç›®å†…å®¹
                    questionDisplay.innerHTML = `
                        <div class="question-title">
                            ${this.getCategoryIcon(question.category)} ${question.topic || question.category}
                        </div>
                        <div class="question-content">
                            ${question.question}
                        </div>
                    `;
                    
                    // æ˜¾ç¤ºç­”é¢˜æŠ€å·§
                    if (question.tips && question.tips.length > 0 && questionTips && tipsList) {
                        tipsList.innerHTML = '';
                        question.tips.forEach(tip => {
                            const li = document.createElement('li');
                            li.textContent = tip;
                            tipsList.appendChild(li);
                        });
                        questionTips.style.display = 'block';
                    } else if (questionTips) {
                        questionTips.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('æ˜¾ç¤ºé¢˜ç›®å¤±è´¥:', error);
                }
            }

            // éšè—å½“å‰é¢˜ç›®
            hideCurrentQuestion() {
                try {
                    const questionDisplay = document.getElementById('currentQuestion');
                    const questionTips = document.getElementById('questionTips');
                    
                    if (questionDisplay) {
                        questionDisplay.innerHTML = `
                            <div style="text-align: center; color: #666; padding: 20px;">
                                <div style="font-size: 2em; margin-bottom: 10px;">ğŸ¯</div>
                                <p>ç‚¹å‡»"éšæœºé¢˜ç›®"å¼€å§‹ç»ƒä¹ ï¼Œæˆ–é€‰æ‹©ç‰¹å®šè¯é¢˜</p>
                            </div>
                        `;
                    }
                    
                    if (questionTips) {
                        questionTips.style.display = 'none';
                    }
                    
                    this.currentQuestion = null;
                } catch (error) {
                    console.error('éšè—é¢˜ç›®å¤±è´¥:', error);
                }
            }

            // è·å–ç±»åˆ«å›¾æ ‡
            getCategoryIcon(category) {
                const icons = {
                    'Part 1': 'ğŸ—£ï¸',
                    'Part 2': 'ğŸ“',
                    'Part 3': 'ğŸ’­',
                    'Practice': 'ğŸ¯'
                };
                return icons[category] || 'ğŸ“š';
            }

            // åˆå§‹åŒ–éŸ³é¢‘å¯è§†åŒ–
            initAudioVisualization(stream) {
                try {
                    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    const source = this.audioContext.createMediaStreamSource(stream);
                    source.connect(this.analyser);

                    // è®¾ç½®åˆ†æå™¨å‚æ•°ï¼ˆä¼˜åŒ–ä¸ºæ—¶åŸŸåˆ†æï¼‰
                    this.analyser.fftSize = 2048; // æ›´é«˜åˆ†è¾¨ç‡ï¼Œè·å¾—æ›´å¹³æ»‘çš„æ³¢å½¢
                    this.analyser.smoothingTimeConstant = 0.3; // å¹³æ»‘å¤„ç†
                    const bufferLength = this.analyser.fftSize;
                    this.dataArray = new Uint8Array(bufferLength);

                    // è·å–Canvaså…ƒç´ 
                    this.canvas = document.getElementById('waveformCanvas');
                    this.canvasCtx = this.canvas.getContext('2d');

                    // éšè—å ä½æ–‡æœ¬
                    document.getElementById('waveformText').style.display = 'none';

                    // å¼€å§‹ç»˜åˆ¶æ³¢å½¢
                    this.drawWaveform();
                    
                } catch (error) {
                    console.error('éŸ³é¢‘å¯è§†åŒ–åˆå§‹åŒ–å¤±è´¥:', error);
                    // å¦‚æœå¯è§†åŒ–å¤±è´¥ï¼Œä¸å½±å“å½•éŸ³åŠŸèƒ½
                }
            }

            // ç»˜åˆ¶å®æ—¶æ³¢å½¢
            drawWaveform() {
                this.animationFrame = requestAnimationFrame(() => this.drawWaveform());

                if (!this.analyser || !this.canvasCtx) return;

                // è·å–æ—¶åŸŸéŸ³é¢‘æ•°æ®ï¼ˆæ³¢å½¢æ•°æ®ï¼‰
                this.analyser.getByteTimeDomainData(this.dataArray);

                const canvas = this.canvas;
                const ctx = this.canvasCtx;
                
                // æ¸…ç©ºç”»å¸ƒå¹¶è®¾ç½®èƒŒæ™¯
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // ç»˜åˆ¶ç½‘æ ¼çº¿
                this.drawGrid(ctx, canvas);

                // è®¡ç®—å½“å‰éŸ³é¢‘çš„å¹³å‡æŒ¯å¹…
                let sum = 0;
                for (let i = 0; i < this.dataArray.length; i++) {
                    sum += Math.abs(this.dataArray[i] - 128);
                }
                const avgVolume = sum / this.dataArray.length;
                
                // è·å–ä¸»è¦é¢‘ç‡åˆ†é‡ä½œä¸ºå½“å‰æ³¢å½¢ç‚¹
                const sensitivity = Math.max(1, Math.min(6, avgVolume / 8));
                const currentWavePoint = ((this.dataArray[50] || 128) - 128) * sensitivity;
                
                // æ·»åŠ åˆ°å†å²æ•°æ®
                this.waveformData.push(currentWavePoint);
                
                // ä¿æŒæ•°æ®é•¿åº¦ä¸è¶…è¿‡ç”»å¸ƒå®½åº¦
                const maxDataPoints = canvas.width;
                if (this.waveformData.length > maxDataPoints) {
                    this.waveformData.shift();
                }

                // ç»˜åˆ¶æ»šåŠ¨æ³¢å½¢
                ctx.strokeStyle = '#27ae60'; // æ”¹ä¸ºç»¿è‰²å¿ƒç”µå›¾çº¿
                ctx.lineWidth = 2;
                ctx.beginPath();

                const centerY = canvas.height / 2;
                
                for (let i = 0; i < this.waveformData.length; i++) {
                    const x = canvas.width - this.waveformData.length + i;
                    const y = centerY + this.waveformData[i] * 0.8;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }

                ctx.stroke();

                // æ·»åŠ å‘å…‰æ•ˆæœ
                ctx.shadowColor = '#27ae60';
                ctx.shadowBlur = 2;
                ctx.stroke();
                ctx.shadowBlur = 0;

                // ç»˜åˆ¶æ‰«æçº¿ï¼ˆç±»ä¼¼ç¤ºæ³¢å™¨ï¼‰
                this.drawScanLine(ctx, canvas);

                // ç»˜åˆ¶éŸ³é‡æŒ‡ç¤ºå™¨
                this.drawVolumeIndicator(ctx, canvas, avgVolume);
            }

            // ç»˜åˆ¶æ‰«æçº¿
            drawScanLine(ctx, canvas) {
                const scanX = canvas.width - 10;
                
                // æ‰«æçº¿
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(scanX, 0);
                ctx.lineTo(scanX, canvas.height);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // æ‰«æçº¿å‘å…‰æ•ˆæœ
                ctx.shadowColor = '#3498db';
                ctx.shadowBlur = 5;
                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            // ç»˜åˆ¶ç½‘æ ¼çº¿
            drawGrid(ctx, canvas) {
                ctx.strokeStyle = '#f0f0f0';
                ctx.lineWidth = 0.5;
                
                // å‚ç›´ç½‘æ ¼çº¿
                const verticalLines = 20;
                for (let i = 0; i <= verticalLines; i++) {
                    const x = (canvas.width / verticalLines) * i;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                // æ°´å¹³ç½‘æ ¼çº¿
                const horizontalLines = 8;
                for (let i = 0; i <= horizontalLines; i++) {
                    const y = (canvas.height / horizontalLines) * i;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }

                // ä¸­å¿ƒçº¿ï¼ˆåŠ ç²—ï¼‰
                ctx.strokeStyle = '#d0d0d0';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, canvas.height / 2);
                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();
            }

            // ç»˜åˆ¶éŸ³é‡æŒ‡ç¤ºå™¨
            drawVolumeIndicator(ctx, canvas, volume) {
                // å³ä¸Šè§’éŸ³é‡æ¡
                const barWidth = 60;
                const barHeight = 10;
                const x = canvas.width - barWidth - 10;
                const y = 10;

                // èƒŒæ™¯
                ctx.fillStyle = '#f5f5f5';
                ctx.fillRect(x, y, barWidth, barHeight);

                // éŸ³é‡æ¡
                const volumeLevel = Math.min(volume / 20, 1); // æ ‡å‡†åŒ–éŸ³é‡
                let color = '#27ae60'; // ç»¿è‰²
                if (volumeLevel > 0.7) color = '#f39c12'; // æ©™è‰²
                if (volumeLevel > 0.9) color = '#e74c3c'; // çº¢è‰²

                ctx.fillStyle = color;
                ctx.fillRect(x, y, barWidth * volumeLevel, barHeight);

                // è¾¹æ¡†
                ctx.strokeStyle = '#bdc3c7';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, barWidth, barHeight);

                // éŸ³é‡æ–‡å­—
                ctx.fillStyle = '#7f8c8d';
                ctx.font = '10px monospace';
                ctx.fillText('VOL', x - 25, y + 8);
            }

            // åœæ­¢éŸ³é¢‘å¯è§†åŒ–
            stopAudioVisualization() {
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                    this.animationFrame = null;
                }

                if (this.audioContext && this.audioContext.state !== 'closed') {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                // æ¸…ç©ºæ³¢å½¢å†å²æ•°æ®
                this.waveformData = [];
                this.scrollOffset = 0;

                // æ¸…ç©ºç”»å¸ƒå¹¶æ˜¾ç¤ºåœæ­¢çŠ¶æ€
                if (this.canvasCtx) {
                    const canvas = this.canvas;
                    const ctx = this.canvasCtx;
                    
                    // å¿ƒç”µå›¾é£æ ¼çš„åœæ­¢çŠ¶æ€
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // ç»˜åˆ¶ç½‘æ ¼
                    this.drawGrid(ctx, canvas);
                    
                    // ç»˜åˆ¶å¹³ç›´çº¿ï¼ˆå¿ƒç”µå›¾åœæ­¢çŠ¶æ€ï¼‰
                    ctx.strokeStyle = '#27ae60';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(0, canvas.height / 2);
                    ctx.lineTo(canvas.width, canvas.height / 2);
                    ctx.stroke();
                }

                // æ˜¾ç¤ºå ä½æ–‡æœ¬
                document.getElementById('waveformText').style.display = 'block';
            }

            // åˆå§‹åŒ–æ³¢å½¢æ˜¾ç¤º
            initWaveformDisplay() {
                try {
                    const canvas = document.getElementById('waveformCanvas');
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    this.canvas = canvas;
                    this.canvasCtx = ctx;
                    
                    // ç»˜åˆ¶åˆå§‹çŠ¶æ€
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // ç»˜åˆ¶ç½‘æ ¼
                    this.drawGrid(ctx, canvas);
                    
                    // ç»˜åˆ¶å‡†å¤‡çŠ¶æ€çš„å¿ƒç‡çº¿ï¼ˆå¹³ç›´çº¿ï¼‰
                    ctx.strokeStyle = '#27ae60';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    const centerY = canvas.height / 2;
                    
                    // ç»˜åˆ¶ä¸€æ¡å¹³ç›´çš„åŸºçº¿
                    ctx.moveTo(0, centerY);
                    ctx.lineTo(canvas.width, centerY);
                    ctx.stroke();
                    
                    // éšè—å ä½æ–‡æœ¬
                    const waveformText = document.getElementById('waveformText');
                    if (waveformText) {
                        waveformText.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('åˆå§‹åŒ–æ³¢å½¢æ˜¾ç¤ºå¤±è´¥:', error);
                }
            }

            // å‘çˆ¶çª—å£å‘é€æ¶ˆæ¯
            sendMessageToParent(action, data = {}) {
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'IELTS_APP_MESSAGE',
                            action: action,
                            data: data,
                            timestamp: Date.now()
                        }, '*');
                        console.log('å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:', action, data);
                    }
                } catch (error) {
                    console.warn('å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£å¤±è´¥:', error);
                }
            }
        }

        // å…¨å±€å˜é‡
        let app;

                        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', async () => {
            app = new IELTSSpeakingAppAI();
            
            // ç«‹å³éšè—å ä½æ–‡æœ¬
            const waveformText = document.getElementById('waveformText');
            if (waveformText) {
                waveformText.style.display = 'none';
            }
            
            // ç¡®ä¿Canvaså®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
            const initWaveform = () => {
                if (app && app.initWaveformDisplay) {
                    app.initWaveformDisplay();
                } else {
                    setTimeout(initWaveform, 100);
                }
            };
            
            // å¤šé‡ä¿éšœåˆå§‹åŒ–
            setTimeout(initWaveform, 200);
        });

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            try {
                // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // æ‰¾åˆ°å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®å¹¶æ¿€æ´»
                const targetTab = document.querySelector(`[onclick*="${tabName}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // ä¿®æ­£æ ‡ç­¾é¡µIDåŒ¹é…
                const targetContent = document.getElementById(`${tabName}-tab`);
                if (targetContent) {
                    targetContent.classList.add('active');
                } else {
                    console.warn(`æœªæ‰¾åˆ°æ ‡ç­¾å†…å®¹: ${tabName}-tab`);
                }
                
                // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾é¡µï¼Œè‡ªåŠ¨åŠ è½½å†å²è®°å½•
                if (tabName === 'history' && app) {
                    app.loadHistory();
                }
                
            } catch (error) {
                console.error('åˆ‡æ¢æ ‡ç­¾é¡µå¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢å½•éŸ³çŠ¶æ€
        function toggleRecording() {
            if (app.isRecording) {
                app.stopRecording();
            } else {
                app.startRecording();
            }
        }

        // ä¿å­˜å½•éŸ³
        function saveRecording() {
            app.saveRecording();
        }

        // ä¸¢å¼ƒå½•éŸ³
        function discardRecording() {
            app.discardRecording();
        }

        // PWA Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                        
                        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å®‰è£…PWA
                        let deferredPrompt;
                        window.addEventListener('beforeinstallprompt', (e) => {
                            e.preventDefault();
                            deferredPrompt = e;
                            
                            // æ˜¾ç¤ºå®‰è£…æç¤º
                            showInstallPrompt(deferredPrompt);
                        });
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // æ˜¾ç¤ºPWAå®‰è£…æç¤º
        function showInstallPrompt(deferredPrompt) {
            // åˆ›å»ºå®‰è£…æç¤ºæ¨ªå¹…
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                color: white; padding: 15px; text-align: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            installBanner.innerHTML = `
                <div style="max-width: 600px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between;">
                    <span>ğŸ“± å®‰è£…IELTS AIåº”ç”¨åˆ°æ¡Œé¢ï¼Œè·å¾—æ›´å¥½çš„ä½¿ç”¨ä½“éªŒï¼</span>
                    <div>
                        <button onclick="installPWA()" style="
                            background: white; color: #4facfe; border: none; padding: 8px 16px;
                            border-radius: 20px; margin-right: 10px; cursor: pointer; font-weight: 600;
                        ">å®‰è£…</button>
                        <button onclick="dismissInstallPrompt()" style="
                            background: transparent; color: white; border: 1px solid white;
                            padding: 8px 16px; border-radius: 20px; cursor: pointer;
                        ">ç¨å</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(installBanner);
            window.installBanner = installBanner;
            window.deferredPrompt = deferredPrompt;
        }

        // å®‰è£…PWA
        function installPWA() {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                window.deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…æç¤º');
                    } else {
                        console.log('ç”¨æˆ·æ‹’ç»äº†å®‰è£…æç¤º');
                    }
                    window.deferredPrompt = null;
                    dismissInstallPrompt();
                });
            }
        }

        // å…³é—­å®‰è£…æç¤º
        function dismissInstallPrompt() {
            if (window.installBanner) {
                window.installBanner.remove();
            }
        }
    </script>
</body>
</html> 